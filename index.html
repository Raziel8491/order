<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Gestione Ordini e Preordini</title>
    <!-- Caricamento di Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configurazione Tailwind per una Dark Mode minimalista e font Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'background-dark': '#1e293b', // Slate-800
                        'card-dark': '#334155', // Slate-700
                        'accent-blue': '#3b82f6', // Blue-500
                        'text-light': '#f8fafc', // Slate-50
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Stili specifici per l'ottimizzazione mobile e iOS */
        body {
            background-color: #1e293b;
            color: #f8fafc;
            /* Per un'esperienza fullscreen su iPhone (modalità PWA) */
            padding-bottom: constant(safe-area-inset-bottom);
            padding-bottom: env(safe-area-inset-bottom);
            -webkit-tap-highlight-color: transparent;
        }

        /* Stili per l'intestazione fissa */
        header {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #1e293b;
            padding-top: max(1rem, constant(safe-area-inset-top));
            padding-top: max(1rem, env(safe-area-inset-top));
        }

        /* Stili per i totali fissi in fondo */
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
            background-color: #334155;
            box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.1), 0 -2px 4px -2px rgb(0 0 0 / 0.1);
            padding-bottom: constant(safe-area-inset-bottom);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Stile per i campi di input con focus dark */
        input:focus, textarea:focus, select:focus {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5) !important;
        }

        /* Scrollbar sottile per browser desktop (se usata) */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <header class="p-4 rounded-b-xl shadow-lg">
        <h1 class="text-2xl font-bold text-center text-accent-blue mb-4">Gestione Ordini</h1>

        <!-- Filtri e Azioni -->
        <div class="flex flex-wrap gap-2 justify-between items-center mb-4">

            <!-- Filtro Tipo A -->
            <select id="filterTypeA" class="flex-1 min-w-[120px] bg-card-dark text-text-light p-2 rounded-lg border border-slate-600 focus:ring-accent-blue focus:border-accent-blue transition duration-150">
                <option value="">Tipo A (Tutti)</option>
                <option value="Ordine">Ordine</option>
                <option value="Preordine">Preordine</option>
            </select>

            <!-- Filtro Tipo B -->
            <select id="filterTypeB" class="flex-1 min-w-[100px] bg-card-dark text-text-light p-2 rounded-lg border border-slate-600 focus:ring-accent-blue focus:border-accent-blue transition duration-150">
                <option value="">Tipo B (Tutti)</option>
                <option value="B">B</option>
                <option value="W">W</option>
            </select>

            <!-- Filtro Ordine Concluso -->
            <select id="filterConcluso" class="flex-1 min-w-[120px] bg-card-dark text-text-light p-2 rounded-lg border border-slate-600 focus:ring-accent-blue focus:border-accent-blue transition duration-150">
                <option value="">Stato (Tutti)</option>
                <option value="No">Da Elaborare (No)</option>
                <option value="Sì">Concluso (Sì)</option>
            </select>

            <!-- Bottone Aggiungi Nuovo -->
            <button onclick="showNewForm()" class="bg-accent-blue hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 min-w-[100px]">
                + Nuovo
            </button>
        </div>

        <!-- Area messaggi/notifiche -->
        <div id="messageArea" class="p-2 bg-green-500/20 text-green-200 rounded-lg text-sm hidden mb-4 transition-all duration-300"></div>

    </header>

    <main class="p-4 mb-40">
        <!-- Modulo di Inserimento/Modifica (Inizialmente nascosto) -->
        <div id="formContainer" class="bg-card-dark p-4 rounded-xl shadow-2xl mb-6 hidden">
            <h2 id="formTitle" class="text-xl font-semibold mb-4 border-b border-slate-600 pb-2">Aggiungi Nuovo Ordine</h2>
            <form id="orderForm" class="space-y-3">
                <input type="hidden" id="orderId">

                <!-- Type A (Ordine/Preordine) -->
                <div class="flex flex-col">
                    <label for="typeA" class="text-sm font-medium mb-1">Tipo A (Ordine/Preordine)</label>
                    <select id="typeA" class="bg-slate-700/50 p-2 rounded-lg border border-slate-600">
                        <option value="">Seleziona Tipo</option>
                        <option value="Ordine">Ordine</option>
                        <option value="Preordine">Preordine</option>
                    </select>
                </div>

                <!-- Type B (B/W) -->
                <div class="flex flex-col">
                    <label for="typeB" class="text-sm font-medium mb-1">Tipo B (B/W)</label>
                    <select id="typeB" class="bg-slate-700/50 p-2 rounded-lg border border-slate-600">
                        <option value="">Seleziona B/W</option>
                        <option value="B">B</option>
                        <option value="W">W</option>
                    </select>
                </div>

                <!-- Nome -->
                <div class="flex flex-col">
                    <label for="nome" class="text-sm font-medium mb-1">Nome Nominativo</label>
                    <input type="text" id="nome" placeholder="Inserisci il nominativo" class="bg-slate-700/50 p-2 rounded-lg border border-slate-600">
                </div>

                <!-- Pezzo -->
                <div class="flex flex-col">
                    <label for="pezzo" class="text-sm font-medium mb-1">Nome Oggetto</label>
                    <input type="text" id="pezzo" placeholder="Nome dell'oggetto" class="bg-slate-700/50 p-2 rounded-lg border border-slate-600">
                </div>

                <!-- Quantità -->
                <div class="flex flex-col">
                    <label for="quantita" class="text-sm font-medium mb-1">Quantità</label>
                    <input type="number" id="quantita" value="" placeholder="0" min="0" class="bg-slate-700/50 p-2 rounded-lg border border-slate-600 text-right">
                </div>

                <!-- Prezzo Unitario -->
                <div class="flex flex-col">
                    <label for="prezzoUnitario" class="text-sm font-medium mb-1">Prezzo Unitario (€)</label>
                    <input type="number" id="prezzoUnitario" value="" placeholder="0.00" min="0" step="0.01" class="bg-slate-700/50 p-2 rounded-lg border border-slate-600 text-right">
                </div>

                <!-- Totale (Calcolato) -->
                <div class="flex justify-between items-center bg-slate-700/50 p-3 rounded-lg border border-slate-600">
                    <span class="text-sm font-medium">Totale:</span>
                    <span id="displayTotale" class="text-lg font-bold text-accent-blue">€ 0.00</span>
                    <input type="hidden" id="totale">
                </div>

                <!-- Data Release -->
                <div class="flex flex-col">
                    <label for="dataRelease" class="text-sm font-medium mb-1">Data Release (Opzionale)</label>
                    <input type="date" id="dataRelease" class="bg-slate-700/50 p-2 rounded-lg border border-slate-600">
                </div>

                <!-- Data Consegna Indicata -->
                <div class="flex flex-col">
                    <label for="dataConsegna" class="text-sm font-medium mb-1">Data di Consegna Indicata (Opzionale)</label>
                    <input type="date" id="dataConsegna" class="bg-slate-700/50 p-2 rounded-lg border border-slate-600">
                </div>

                <!-- Ordine Concluso -->
                <div class="flex flex-col">
                    <label for="ordineConcluso" class="text-sm font-medium mb-1">Ordine Concluso</label>
                    <select id="ordineConcluso" class="bg-slate-700/50 p-2 rounded-lg border border-slate-600">
                        <option value="No">No (Da elaborare)</option>
                        <option value="Sì">Sì (Concluso)</option>
                    </select>
                </div>

                <!-- Note (Max 50 caratteri) -->
                <div class="flex flex-col">
                    <label for="note" class="text-sm font-medium mb-1 flex justify-between">
                        Note (Max 50 caratteri)
                        <span id="noteCount" class="text-xs text-slate-400">0/50</span>
                    </label>
                    <textarea id="note" rows="2" maxlength="50" placeholder="Inserisci note (max 50 caratteri)" class="bg-slate-700/50 p-2 rounded-lg border border-slate-600 resize-none"></textarea>
                </div>

                <!-- Bottoni Salva e Annulla -->
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="saveOrder()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg shadow-lg transition duration-150">
                        Salva Ordine
                    </button>
                    <button type="button" onclick="hideForm()" class="flex-1 bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 rounded-lg shadow-lg transition duration-150">
                        Annulla
                    </button>
                </div>
            </form>
        </div>

        <!-- Lista degli Ordini Filtrati -->
        <div id="orderList" class="space-y-4">
            <!-- Gli ordini verranno inseriti qui dal JS -->
        </div>

        <!-- Messaggio di Nessun Ordine -->
        <p id="noOrdersMessage" class="text-center text-slate-400 mt-10 text-lg hidden">Nessun ordine trovato con i filtri attuali.</p>

        <!-- Modale per conferma eliminazione -->
        <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
            <div class="bg-card-dark p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4">Conferma Eliminazione</h3>
                <p class="mb-6">Sei sicuro di voler eliminare l'ordine selezionato? Questa azione è irreversibile.</p>
                <div class="flex gap-4 justify-end">
                    <button id="cancelDeleteBtn" class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                        Annulla
                    </button>
                    <button id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                        Elimina
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer Fisso per i Totali e Azioni Globali -->
    <footer class="p-4 rounded-t-xl">
        <!-- Totali Complessivi (Filtri applicati) -->
        <div class="flex justify-around text-center mb-4 border-b border-slate-600 pb-2">
            <div>
                <p class="text-xs text-slate-400">Totale Elementi</p>
                <p id="totalCount" class="text-xl font-bold">0</p>
            </div>
            <div>
                <p class="text-xs text-slate-400">Totale Prezzo (€)</p>
                <p id="totalValue" class="text-xl font-bold text-green-400">€ 0.00</p>
            </div>
        </div>

        <!-- Tasti Esporta/Importa -->
        <div class="flex gap-4">
            <button onclick="exportData()" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white font-semibold py-2 rounded-lg shadow-md transition duration-150 text-sm">
                Esporta Dati (JSON)
            </button>
            <input type="file" id="importFile" accept=".json" class="hidden" onchange="importData(event)">
            <button onclick="document.getElementById('importFile').click()" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white font-semibold py-2 rounded-lg shadow-md transition duration-150 text-sm">
                Importa Dati (JSON)
            </button>
        </div>
    </footer>


    <script>
        const STORAGE_KEY = 'ordersData';
        let orders = [];
        let orderToDeleteId = null;

        // Funzione helper per formattare la valuta
        const formatCurrency = (amount) => {
            // Assicura che amount sia un numero
            const num = parseFloat(amount);
            if (isNaN(num)) return '€ 0.00';

            return new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 2,
            }).format(num);
        };

        // ---------------------------------------------
        // 1. GESTIONE DEI DATI E LOCALSTORAGE
        // ---------------------------------------------

        // Carica i dati dal localStorage all'avvio
        const loadOrders = () => {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                orders = data ? JSON.parse(data) : [];
                // Ordina per default i "Non Conclusi" prima e poi per ID decrescente
                orders.sort((a, b) => {
                    if (a.ordineConcluso === 'No' && b.ordineConcluso === 'Sì') return -1;
                    if (a.ordineConcluso === 'Sì' && b.ordineConcluso === 'No') return 1;
                    return b.id - a.id; // Ultimi inseriti in alto
                });
                applyFilters();
            } catch (e) {
                console.error("Errore nel caricamento dei dati dal localStorage:", e);
                orders = [];
                showMessage("Attenzione: Impossibile caricare i dati. localStorage non accessibile.", 'red');
            }
        };

        // Salva i dati nel localStorage
        const saveOrders = () => {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(orders));
                // Dopo il salvataggio, riapplica i filtri per aggiornare la visualizzazione
                applyFilters();
            } catch (e) {
                console.error("Errore nel salvataggio dei dati nel localStorage:", e);
                showMessage("Attenzione: Impossibile salvare i dati. Spazio esaurito o errore.", 'red');
            }
        };

        // ---------------------------------------------
        // 2. GESTIONE DEL MODULO DI INSERIMENTO/MODIFICA
        // ---------------------------------------------

        // Calcola e aggiorna il totale in tempo reale
        const updateTotale = () => {
            const quantitaInput = document.getElementById('quantita');
            const prezzoInput = document.getElementById('prezzoUnitario');

            const quantita = parseInt(quantitaInput.value) || 0;
            const prezzoUnitario = parseFloat(prezzoInput.value) || 0.00;

            const totale = quantita * prezzoUnitario;

            document.getElementById('displayTotale').textContent = formatCurrency(totale);
            document.getElementById('totale').value = totale.toFixed(2); // Salva il valore con 2 decimali
        };

        // Aggiorna il contatore dei caratteri delle note
        const updateNoteCount = () => {
            const noteInput = document.getElementById('note');
            const countSpan = document.getElementById('noteCount');
            const length = noteInput.value.length;
            countSpan.textContent = `${length}/50`;
        };

        // Aggiunge listener per il calcolo del totale e il conteggio note
        document.getElementById('quantita').addEventListener('input', updateTotale);
        document.getElementById('prezzoUnitario').addEventListener('input', updateTotale);
        document.getElementById('note').addEventListener('input', updateNoteCount);

        // Mostra il modulo e lo resetta per un nuovo inserimento
        const showNewForm = () => {
            const formContainer = document.getElementById('formContainer');
            document.getElementById('orderForm').reset();
            document.getElementById('orderId').value = '';
            document.getElementById('formTitle').textContent = 'Aggiungi Nuovo Ordine';
            document.getElementById('displayTotale').textContent = formatCurrency(0);
            updateNoteCount();
            formContainer.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Scrolla in cima
        };

        // Nasconde il modulo
        const hideForm = () => {
            document.getElementById('formContainer').classList.add('hidden');
        };

        // Popola il modulo con i dati dell'ordine per la modifica
        const editOrder = (id) => {
            const order = orders.find(o => o.id === id);
            if (!order) return;

            const formContainer = document.getElementById('formContainer');
            document.getElementById('orderId').value = order.id;
            document.getElementById('formTitle').textContent = 'Modifica Ordine';

            // Popola i campi (assicurandosi che i numeri siano gestiti correttamente)
            document.getElementById('typeA').value = order.typeA || '';
            document.getElementById('typeB').value = order.typeB || '';
            document.getElementById('nome').value = order.nome || '';
            document.getElementById('pezzo').value = order.pezzo || '';
            document.getElementById('quantita').value = order.quantita || '';
            document.getElementById('prezzoUnitario').value = order.prezzoUnitario || '';
            document.getElementById('dataRelease').value = order.dataRelease || '';
            document.getElementById('dataConsegna').value = order.dataConsegna || '';
            document.getElementById('ordineConcluso').value = order.ordineConcluso || 'No';
            document.getElementById('note').value = order.note || '';

            updateTotale();
            updateNoteCount();
            formContainer.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Scrolla in cima
        };

        // Salva un nuovo ordine o aggiorna uno esistente
        const saveOrder = () => {
            const id = document.getElementById('orderId').value;

            // Raccogli i dati dal form
            const quantitaVal = document.getElementById('quantita').value;
            const prezzoUnitarioVal = document.getElementById('prezzoUnitario').value;

            const newOrder = {
                id: id ? parseInt(id) : Date.now(), // Usa un timestamp come ID univoco
                typeA: document.getElementById('typeA').value,
                typeB: document.getElementById('typeB').value,
                nome: document.getElementById('nome').value.trim(),
                pezzo: document.getElementById('pezzo').value.trim(),
                quantita: quantitaVal ? parseInt(quantitaVal) : null,
                prezzoUnitario: prezzoUnitarioVal ? parseFloat(prezzoUnitarioVal) : null,
                // Il totale è già calcolato in updateTotale, ma lo ricalcoliamo per sicurezza
                totale: (quantitaVal && prezzoUnitarioVal) ? (parseInt(quantitaVal) * parseFloat(prezzoUnitarioVal)).toFixed(2) : null,
                dataRelease: document.getElementById('dataRelease').value,
                dataConsegna: document.getElementById('dataConsegna').value,
                ordineConcluso: document.getElementById('ordineConcluso').value || 'No',
                note: document.getElementById('note').value.trim().substring(0, 50), // Troncamento garantito a 50 caratteri
            };

            if (id) {
                // Modifica
                const index = orders.findIndex(o => o.id === parseInt(id));
                if (index !== -1) {
                    orders[index] = newOrder;
                    showMessage('Ordine modificato con successo!', 'green');
                }
            } else {
                // Nuovo Inserimento
                orders.push(newOrder);
                showMessage('Nuovo ordine aggiunto con successo!', 'green');
            }

            hideForm();
            saveOrders(); // Salva e aggiorna la lista
        };

        // ---------------------------------------------
        // 3. VISUALIZZAZIONE E FILTRI
        // ---------------------------------------------

        // Applica i filtri e aggiorna la lista degli ordini
        const applyFilters = () => {
            const filterA = document.getElementById('filterTypeA').value;
            const filterB = document.getElementById('filterTypeB').value;
            const filterConcluso = document.getElementById('filterConcluso').value;

            const filteredOrders = orders.filter(order => {
                const matchA = !filterA || order.typeA === filterA;
                const matchB = !filterB || order.typeB === filterB;
                const matchConcluso = !filterConcluso || order.ordineConcluso === filterConcluso;
                return matchA && matchB && matchConcluso;
            });

            renderOrders(filteredOrders);
            updateGlobalTotals(filteredOrders);
        };

        // Aggiorna i totali globali
        const updateGlobalTotals = (list) => {
            const totalCount = list.length;
            const totalValue = list.reduce((sum, order) => {
                const total = parseFloat(order.totale);
                return sum + (isNaN(total) ? 0 : total);
            }, 0);

            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('totalValue').textContent = formatCurrency(totalValue);
        };

        // Renderizza la lista degli ordini filtrati
        const renderOrders = (list) => {
            const orderList = document.getElementById('orderList');
            orderList.innerHTML = '';
            const noOrdersMessage = document.getElementById('noOrdersMessage');

            if (list.length === 0) {
                noOrdersMessage.classList.remove('hidden');
                return;
            }

            noOrdersMessage.classList.add('hidden');

            list.forEach(order => {
                const card = document.createElement('div');
                card.className = `bg-card-dark p-4 rounded-xl shadow-lg border-l-4 ${order.ordineConcluso === 'Sì' ? 'border-green-500 opacity-70' : 'border-accent-blue'} transition duration-150`;

                // Badge per il tipo di ordine
                const statusBadge = `<span class="text-xs font-semibold px-2 py-0.5 rounded-full ${order.ordineConcluso === 'Sì' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}">${order.ordineConcluso === 'Sì' ? 'Concluso' : 'Da Elaborare'}</span>`;

                // Badge per i tipi A e B
                const typeBadges = `
                    <span class="text-xs font-medium px-2 py-0.5 rounded-full bg-slate-500/50">${order.typeA || 'N/A'}</span>
                    <span class="text-xs font-medium px-2 py-0.5 rounded-full bg-slate-500/50">${order.typeB || 'N/A'}</span>
                `;

                // Calcolo e formattazione dei dati
                const totale = parseFloat(order.totale);
                const displayTotale = formatCurrency(totale);
                const quantitaDisplay = order.quantita !== null ? order.quantita : 'N/D';
                const prezzoUnitarioDisplay = order.prezzoUnitario !== null ? formatCurrency(order.prezzoUnitario) : 'N/D';

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2 border-b border-slate-700 pb-2">
                        <h3 class="text-lg font-bold truncate pr-4">${order.pezzo || 'Oggetto Senza Nome'}</h3>
                        <div class="flex-shrink-0 flex gap-1 items-center">
                           ${statusBadge}
                        </div>
                    </div>

                    <p class="text-sm text-slate-300 mb-2">
                        <span class="font-semibold">${order.nome || 'Nominativo Sconosciuto'}</span>
                    </p>

                    <div class="grid grid-cols-2 gap-y-1 text-sm mb-4">
                        <p class="text-slate-400">Tipi:</p>
                        <div class="flex gap-2 justify-end">${typeBadges}</div>

                        <p class="text-slate-400">Quantità / Prezzo Unitario:</p>
                        <p class="text-right font-medium">${quantitaDisplay} / ${prezzoUnitarioDisplay}</p>

                        <p class="text-slate-400 font-bold">Totale:</p>
                        <p class="text-right text-lg font-extrabold text-green-400">${displayTotale}</p>

                        <p class="text-slate-400">Data Release:</p>
                        <p class="text-right">${order.dataRelease || 'N/D'}</p>

                        <p class="text-slate-400">Data Consegna Indicata:</p>
                        <p class="text-right">${order.dataConsegna || 'N/D'}</p>
                    </div>

                    ${order.note ? `<div class="mt-2 text-sm italic border-t border-slate-700 pt-2 text-slate-300">Note: ${order.note}</div>` : ''}

                    <div class="flex gap-2 mt-4 pt-3 border-t border-slate-700">
                        <button onclick="editOrder(${order.id})" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white text-sm py-2 rounded-lg transition duration-150">
                            Modifica
                        </button>
                        <button onclick="showDeleteModal(${order.id})" class="bg-red-700/50 hover:bg-red-600/70 text-white text-sm w-1/4 py-2 rounded-lg transition duration-150">
                            Elimina
                        </button>
                    </div>
                `;
                orderList.appendChild(card);
            });
        };

        // Aggiunge listener ai filtri per l'aggiornamento automatico
        document.getElementById('filterTypeA').addEventListener('change', applyFilters);
        document.getElementById('filterTypeB').addEventListener('change', applyFilters);
        document.getElementById('filterConcluso').addEventListener('change', applyFilters);

        // ---------------------------------------------
        // 4. ELIMINAZIONE
        // ---------------------------------------------

        // Mostra il modale di conferma eliminazione
        const showDeleteModal = (id) => {
            orderToDeleteId = id;
            document.getElementById('deleteModal').classList.remove('hidden');
        };

        // Nasconde il modale
        const hideDeleteModal = () => {
            orderToDeleteId = null;
            document.getElementById('deleteModal').classList.add('hidden');
        };

        // Logica di eliminazione
        const deleteOrder = () => {
            if (orderToDeleteId !== null) {
                orders = orders.filter(o => o.id !== orderToDeleteId);
                saveOrders();
                showMessage('Ordine eliminato con successo.', 'red');
            }
            hideDeleteModal();
        };

        // Listener per i bottoni del modale
        document.getElementById('confirmDeleteBtn').addEventListener('click', deleteOrder);
        document.getElementById('cancelDeleteBtn').addEventListener('click', hideDeleteModal);

        // ---------------------------------------------
        // 5. IMPORT/EXPORT DATI
        // ---------------------------------------------

        // Esporta i dati attuali in un file JSON
        const exportData = () => {
            if (orders.length === 0) {
                showMessage('Nessun dato da esportare.', 'yellow');
                return;
            }
            try {
                const dataStr = JSON.stringify(orders, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

                const exportFileDefaultName = 'ordini_backup_' + new Date().toISOString().slice(0, 10) + '.json';

                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                showMessage('Dati esportati con successo come ' + exportFileDefaultName, 'green');
            } catch (e) {
                console.error("Errore in esportazione:", e);
                showMessage('Errore durante l\'esportazione dei dati.', 'red');
            }
        };

        // Importa dati da un file JSON
        const importData = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedOrders = JSON.parse(e.target.result);

                    if (!Array.isArray(importedOrders)) {
                        throw new Error('Il file JSON non contiene un array valido di ordini.');
                    }

                    // Semplice controllo di integrità
                    const isValid = importedOrders.every(item => typeof item.id === 'number' && typeof item.totale === 'string' || item.totale === null);
                    if (!isValid) {
                        throw new Error('Il file sembra non essere un backup valido (struttura dati errata).');
                    }

                    // Sovrascrive i dati esistenti
                    orders = importedOrders;
                    saveOrders();
                    showMessage(`Dati importati con successo! Sono stati caricati ${orders.length} elementi.`, 'green');

                } catch (error) {
                    console.error("Errore durante l'importazione:", error);
                    showMessage(`Errore nell'importazione del file: ${error.message}`, 'red');
                }
            };
            reader.readAsText(file);
            // Resetta l'input file per consentire l'importazione dello stesso file più volte
            event.target.value = '';
        };

        // ---------------------------------------------
        // 6. FUNZIONE MESSAGGIO E AVVIO
        // ---------------------------------------------

        // Funzione per mostrare messaggi temporanei
        const showMessage = (text, type = 'green') => {
            const area = document.getElementById('messageArea');
            let color = '';

            switch (type) {
                case 'green':
                    color = 'bg-green-500/20 text-green-200';
                    break;
                case 'red':
                    color = 'bg-red-500/20 text-red-200';
                    break;
                case 'yellow':
                    color = 'bg-yellow-500/20 text-yellow-200';
                    break;
                default:
                    color = 'bg-green-500/20 text-green-200';
            }

            area.className = `p-2 ${color} rounded-lg text-sm mb-4 transition-all duration-300`;
            area.textContent = text;
            area.classList.remove('hidden');

            setTimeout(() => {
                area.classList.add('hidden');
            }, 5000);
        };

        // Avvio dell'applicazione
        window.onload = () => {
            loadOrders();
            // Inizializza i totali
            updateGlobalTotals(orders);
        };

    </script>

</body>
</html>